<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bisaya Fire Nation</title>

  <meta name="theme-color" content="#ff4500" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="images/bfn.png" />
  <link rel="apple-touch-icon" href="images/bfn.png" />

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===============================
      THEME COLOR VARIABLES (FIX)
    ============================== */
    :root{
      --text-main:#111;
      --text-muted: rgba(0,0,0,.75);
    }
    html[data-theme="dark"]{
      --text-main:#fff;
      --text-muted: rgba(255,255,255,.85);
    }

    /* ===============================
      SIDEBAR TOGGLE
    ============================== */
    .sidebar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
      gap:10px;
    }
    .sidebar-links{
      overflow:hidden;
      max-height:500px;
      transition:max-height .3s ease;
    }
    .sidebar-links.closed{ max-height:0; }
    #sidebarArrow{ transition:transform .3s ease; }
    #sidebarArrow.rotated{ transform: rotate(-90deg); }

    /* ===============================
      FB-STYLE POST
    ============================== */
    .post{ position:relative; }
    .post h2{ margin-bottom:8px; }
    .post-body{ overflow:visible; max-height:none; }

    .fb p{ margin: 8px 0; line-height: 1.35; }
    .fb h3{ margin: 14px 0 6px; font-size: 1.05rem; }
    .fb .bullets{ margin:10px 0 0; padding-left:0; list-style:none; }
    .fb .bullets li{ margin:6px 0; }
    .fb .bullets li::before{ content:"‚Ä¢ "; opacity:.75; }

    /* ===============================
      POST IMAGES (clickable)
    ============================== */
    .img-placeholder{
      margin:12px 0;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .img-placeholder img{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
      cursor: zoom-in;
      transition: transform .2s ease, filter .2s ease;
    }
    .img-placeholder img:hover{
      transform: scale(1.01);
      filter: brightness(1.03);
    }

    /* ===============================
      ‚úÖ FACEBOOK-LIKE IMAGE VIEWER (FULL CSS)
    ============================== */
    .img-viewer{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.86);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 18px;
    }
    .img-viewer.show{ display:flex; }

    .viewer-inner{
      position:relative;
      width:min(1100px, 100%);
      height:min(86vh, 860px);
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-user-select:none;
      user-select:none;
    }

    .viewer-img{
      max-width:100%;
      max-height:100%;
      border-radius:16px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      user-select:none;
      -webkit-user-drag:none;
      cursor: grab;
      touch-action:none;
      transform-origin:center center;
      will-change: transform;
      transition: transform .08s linear;
    }
    .viewer-img:active{ cursor: grabbing; }

    .viewer-topbar{
      position:absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }

    .viewer-pill{
      pointer-events:auto;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      font-weight:800;
      font-size:.9rem;
      display:flex;
      align-items:center;
      gap:8px;
      max-width: 70%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .viewer-actions{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .vbtn{
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      transition: transform .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .vbtn:hover{ transform: translateY(-1px); filter: brightness(1.08); }
    .vbtn:active{ transform: translateY(0); }
    .vbtn.primary{
      background: rgba(255,69,0,.35);
      border-color: rgba(255,69,0,.45);
    }

    .viewer-nav{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .viewer-nav .navbtn{
      pointer-events:auto;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      display:grid;
      place-items:center;
      margin: 0 8px;
      transition: transform .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .viewer-nav .navbtn:hover{ transform: scale(1.04); filter: brightness(1.1); }

    .viewer-bottom{
      position:absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      pointer-events:none;
    }
    .hint{
      pointer-events:auto;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      font-size:.85rem;
      opacity:.9;
    }

    @media (max-width: 520px){
      .viewer-inner{ height: 82vh; }
      .viewer-pill{ max-width: 58%; }
      .viewer-actions .vbtn{ padding: 9px 10px; }
    }

    /* ===============================
      ‚úÖ HERO (with background FIX)
    ============================== */
    .hero{
      position:relative;
      width:100%;
      min-height:550px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 40px 0;
      background: transparent;
    }

    /* ‚úÖ FIX: these were missing (hero image broke without them) */
    .hero-pattern{
      position:absolute;
      inset:0;
      z-index:0;
      opacity:.05;
      pointer-events:none;
      background-image:url("images/abstract.png");
      background-size:300px;
      background-repeat:repeat;
    }
    .hero-banner{
      position:absolute;
      top:0;
      left:0;
      right:0;
      margin:0 auto;
      width:100%;
      max-width:1600px;
      height:550px;
      z-index:1;
      background-image:url("images/image.png");
      background-size:100% 100%;
      background-position:center top;
      background-repeat:no-repeat;
      pointer-events:none;
    }
    .hero-fade{
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
      background: linear-gradient(to bottom, rgba(0,0,0,.18), rgba(0,0,0,0));
    }

    .hero-content{
      position:relative;
      z-index:3;
      width:100%;
      padding:0 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }

    .hero-head{
      text-align:center;
      max-width:900px;
      animation: heroIn .7s ease both;
    }

    .hero-head h1{
      margin:0;
      font-weight:900;
      text-transform:uppercase;
      color: var(--text-main);
      text-shadow:0 10px 30px rgba(0,0,0,.4);
      font-size: clamp(28px, 4.2vw, 52px);
    }

    .hero-head p{
      margin-top:10px;
      color: var(--text-muted);
      font-weight:600;
    }

    /* ===============================
      CTA BUTTONS
    ============================== */
    .hero-cta{
      width:100%;
      max-width:980px;
      display:flex;
      flex-wrap:wrap;
      gap:15px;
      justify-content:center;
      margin-bottom:15px;
    }

    .cta-btn{
      width:300px;
      height:50px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      color:#fff;
      font-weight:900;
      font-size:1.15rem;
      text-decoration:none;
      transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
    }

    .cta-btn:hover{
      transform: scale(1.05);
      filter: brightness(1.05);
    }

    .cta-btn svg{ width:24px; height:24px; }

    /* üî• FIRE RED ORANGE BUTTON */
    .cta-purple{
      background: linear-gradient(90deg, #ff2a00, #ff9a00);
      box-shadow: 0 0 30px rgba(255, 90, 0, 0.55);
    }
    .cta-purple:hover{
      box-shadow: 0 0 55px rgba(255, 140, 0, 0.85);
    }

    /* DISCORD */
    .cta-discord{
      background: linear-gradient(90deg, #5865F2, #4752C4);
      box-shadow: 0 0 30px rgba(88,101,242,0.40);
    }
    .cta-discord:hover{ box-shadow: 0 0 50px rgba(88,101,242,0.60); }

    @keyframes heroIn{
      from{ opacity:0; transform: translateY(-10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* ===============================
      MUSIC WIDGET (kept)
    ============================== */
    .music-widget{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9998;
      width: min(360px, calc(100vw - 32px));
      background: rgba(20,20,26,.72);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      color: #fff;
      overflow:hidden;
      user-select:none;
    }
  </style>
</head>

<body>

  <header>
    <div class="header-inner">
      <div class="logo" onclick="window.scrollTo({top:0, behavior:'smooth'})">
        <img src="images/bfn.png" alt="BFN Logo" />
      </div>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="update.html">Update</a>
        <a href="event.html">Events</a>
        <a href="download.html">Downloads</a>
        <a href="staff.html">Staff</a>
      </nav>

      <button id="themeToggle" title="Toggle Theme" aria-label="Toggle Theme">‚òÄÔ∏è</button>
    </div>
  </header>

  <!-- ‚úÖ HERO SECTION -->
  <section class="hero" aria-label="Hero">
    <div class="hero-pattern"></div>
    <div class="hero-banner"></div>
    <div class="hero-fade"></div>

    <div class="hero-content">
      <div class="hero-head">
        <h1>The Ultimate iDate Dance Game Is Officially Back</h1>
        <p>Step back onto the dance floor. The classic beats, style, and community you loved are here again.</p>
      </div>

      <div class="hero-cta">
        <a class="cta-btn cta-purple" href="download.html">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 15V3"></path>
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <path d="m7 10 5 5 5-5"></path>
          </svg>
          Free to Play!
        </a>

        <a class="cta-btn cta-discord" href="https://discord.gg/snbNdkrcEr" target="_blank" rel="noopener">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.211.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"></path>
          </svg>
          Join Discord Server
        </a>
      </div>
    </div>
  </section>

  <br><br><br><br><br><br><br><br>

  <div class="container">
    <main>
      <article class="post fb">
        <h2>üî• Welcome to BFN</h2>

        <div class="post-body">
          <p><b>Play Together. Compete Together. Grow Together.</b></p>

          <p>
            Bisaya Fire Nation is a clan built on discipline, teamwork, and consistent performance.
            It is made up of both casual and competitive players who enjoy playing, improving, and
            building real connections through the game. We take competitions seriously, but we also
            believe that gaming should stay fun, welcoming, and community-driven.
          </p>

          <div class="img-placeholder">
            <img src="images/idate/1.jpg" alt="BFN Image 1" loading="lazy" class="post-img" data-caption="BFN Image 1">
          </div>

          <h3>Who We Are</h3>
          <p>
            A group of players brought together by our love for iDate. Founded as a community-driven clan,
            Bisaya Fire Nation competes in organized tournaments while maintaining a supportive environment
            for player development. Some of us play casually, others aim to compete‚Äîbut everyone is here
            to learn, support each other, and enjoy the game.
          </p>

          <div class="img-placeholder">
            <img src="images/idate/2.jpg" alt="BFN Image 2" loading="lazy" class="post-img" data-caption="BFN Image 2">
          </div>

          <h3>What We Do</h3>
          <ul class="bullets">
            <li>Play any modes together in both iDatePH servers</li>
            <li>Host and participate in organized competitive events</li>
            <li>Conduct structured player evaluations and tryouts</li>
            <li>Maintain an active and professional gaming community</li>
          </ul>

          <div class="img-placeholder">
            <img src="images/idate/3.jpg" alt="BFN Image 3" loading="lazy" class="post-img" data-caption="BFN Image 3">
          </div>

          <h3>Casual and Competitive Standards</h3>
          <p>
            Bisaya Fire Nation operates under clear rules and performance expectations.
            All members are evaluated based on gameplay consistency, teamwork, and conduct.
            This ensures a fair, organized, and competitive environment for everyone involved.
          </p>

          <div class="img-placeholder">
            <img src="images/idate/4.jpg" alt="BFN Image 4" loading="lazy" class="post-img" data-caption="BFN Image 4">
          </div>

          <h3>Join the Fire</h3>
          <p>
            We are continuously recruiting dedicated players who are ready to compete, improve,
            and represent the clan with integrity.
          </p>
          <p>
            Visit the Join Us page to view requirements and begin the application process.
          </p>
        </div>
      </article>
    </main>
  </div>

  <!-- ‚úÖ IMAGE VIEWER MODAL -->
  <div class="img-viewer" id="imgViewer" aria-hidden="true">
    <div class="viewer-inner" role="dialog" aria-modal="true" aria-label="Image viewer">

      <div class="viewer-topbar">
        <div class="viewer-pill" id="viewerCaption">üì∑ Image</div>
        <div class="viewer-actions">
          <button class="vbtn" id="zoomOutBtn" title="Zoom out">‚ûñ</button>
          <button class="vbtn" id="zoomInBtn" title="Zoom in">‚ûï</button>
          <button class="vbtn" id="resetZoomBtn" title="Reset">‚Ü©Ô∏è</button>
          <button class="vbtn primary" id="closeViewerBtn" title="Close (Esc)">‚úñ</button>
        </div>
      </div>

      <div class="viewer-nav">
        <button class="navbtn" id="prevImgBtn" title="Previous (‚Üê)">‚ü®</button>
        <button class="navbtn" id="nextImgBtn" title="Next (‚Üí)">‚ü©</button>
      </div>

      <img class="viewer-img" id="viewerImg" src="" alt="Full view" />

      <div class="viewer-bottom">
        <span class="hint">Click outside to close</span>
        <span class="hint">Scroll / pinch to zoom</span>
        <span class="hint">‚Üê / ‚Üí to navigate</span>
      </div>
    </div>
  </div>

    <!-- ‚úÖ AUDIO -->
  <audio id="bgm" preload="auto"></audio>

  <!-- ‚úÖ MUSIC WIDGET -->
  <div class="music-widget" id="musicWidget">
    <div class="music-mini-bar">
      <span id="miniStatus">üéµ BGM</span>
      <button class="music-min-btn" id="expandBtn" title="Expand">‚¨ÜÔ∏è</button>
    </div>

    <div class="music-top">
      <div class="music-title" id="songName">üéµ BFN BGM</div>
      <div class="music-status" id="songStatus">Paused</div>
    </div>

    <div class="music-controls">
      <button class="m-btn" id="prevBtn" title="Previous">‚èÆÔ∏è</button>
      <button class="m-btn primary" id="playBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
      <button class="m-btn" id="nextBtn" title="Next">‚è≠Ô∏è</button>
      <button class="m-btn" id="shuffleBtn" title="Shuffle">üîÄ</button>
      <button class="m-btn" id="minBtn" title="Minimize">‚ûñ</button>
    </div>

    <div class="music-row">
      <span class="vol-label">üîä Vol</span>
      <input id="volRange" class="vol-range" type="range" min="0" max="100" value="50">
    </div>

    <div class="music-mini">
      <span class="pill" id="modePill">Mode: Loop</span>
      <span class="pill" id="trackPill">Track: 1/4</span>
    </div>
  </div>

  <script>
    /* ‚úÖ SAFE THEME TOGGLE */
    const toggle = document.getElementById("themeToggle");
    const root = document.documentElement;

    const savedTheme = localStorage.getItem("theme");
    const startTheme = savedTheme ? savedTheme : "light";

    root.setAttribute("data-theme", startTheme);
    toggle.textContent = startTheme === "light" ? "‚òÄÔ∏è" : "üåô";

    toggle.addEventListener("click", () => {
      const current = root.getAttribute("data-theme");
      const newTheme = current === "light" ? "dark" : "light";
      root.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
      toggle.textContent = newTheme === "light" ? "‚òÄÔ∏è" : "üåô";
    });

    /* ===============================
       ‚úÖ FACEBOOK-LIKE IMAGE VIEWER (Zoom + Drag + Pinch + Double Tap)
    ============================== */
    const imgViewer = document.getElementById("imgViewer");
    const viewerImg = document.getElementById("viewerImg");
    const viewerCaption = document.getElementById("viewerCaption");
    const closeViewerBtn = document.getElementById("closeViewerBtn");
    const prevImgBtn = document.getElementById("prevImgBtn");
    const nextImgBtn = document.getElementById("nextImgBtn");

    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const resetZoomBtn = document.getElementById("resetZoomBtn");

    const postImages = Array.from(document.querySelectorAll(".post-img"));
    let currentImgIndex = 0;

    let scale = 1;
    let translateX = 0;
    let translateY = 0;

    let dragging = false;
    let startX = 0, startY = 0;

    let pinching = false;
    let pinchStartDist = 0;
    let pinchStartScale = 1;
    let pinchMidX = 0, pinchMidY = 0;

    let lastTapTime = 0;
    let lastTapX = 0, lastTapY = 0;

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function applyTransform(){
      viewerImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function resetTransform(){
      scale = 1;
      translateX = 0;
      translateY = 0;
      applyTransform();
    }

    function setViewer(index){
      if(!postImages.length) return;
      currentImgIndex = (index + postImages.length) % postImages.length;
      const img = postImages[currentImgIndex];
      viewerImg.src = img.getAttribute("src");
      viewerCaption.textContent = "üì∑ " + (img.dataset.caption || img.alt || "Image");
      resetTransform();
    }

    function openViewer(index){
      if(!postImages.length) return;
      setViewer(index);
      imgViewer.classList.add("show");
      imgViewer.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeViewer(){
      imgViewer.classList.remove("show");
      imgViewer.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      viewerImg.src = "";
      resetTransform();
    }

    function nextImage(){ setViewer(currentImgIndex + 1); }
    function prevImage(){ setViewer(currentImgIndex - 1); }

    postImages.forEach((img, idx) => {
      img.addEventListener("click", (e) => { e.preventDefault(); openViewer(idx); });
    });

    imgViewer.addEventListener("click", (e) => {
      if(e.target === imgViewer) closeViewer();
    });
    closeViewerBtn.addEventListener("click", closeViewer);

    prevImgBtn.addEventListener("click", (e) => { e.preventDefault(); prevImage(); });
    nextImgBtn.addEventListener("click", (e) => { e.preventDefault(); nextImage(); });

    document.addEventListener("keydown", (e) => {
      if(!imgViewer.classList.contains("show")) return;
      if(e.key === "Escape") closeViewer();
      if(e.key === "ArrowRight") nextImage();
      if(e.key === "ArrowLeft") prevImage();
    });

    function zoomTo(newScale, centerX, centerY){
      newScale = clamp(newScale, 1, 4);

      const rect = viewerImg.getBoundingClientRect();
      const imgCenterX = rect.left + rect.width / 2;
      const imgCenterY = rect.top + rect.height / 2;

      const dx = centerX - imgCenterX;
      const dy = centerY - imgCenterY;

      const scaleChange = newScale / scale;
      translateX = translateX * scaleChange + dx * (1 - scaleChange);
      translateY = translateY * scaleChange + dy * (1 - scaleChange);

      scale = newScale;
      applyTransform();
    }

    function zoomBy(factor, cx, cy){
      const centerX = cx ?? (window.innerWidth/2);
      const centerY = cy ?? (window.innerHeight/2);
      zoomTo(scale * factor, centerX, centerY);
    }

    zoomInBtn.addEventListener("click", () => zoomBy(1.18));
    zoomOutBtn.addEventListener("click", () => zoomBy(1/1.18));
    resetZoomBtn.addEventListener("click", resetTransform);

    viewerImg.addEventListener("wheel", (e) => {
      if(!imgViewer.classList.contains("show")) return;
      e.preventDefault();
      const factor = e.deltaY > 0 ? (1/1.12) : 1.12;
      zoomBy(factor, e.clientX, e.clientY);
    }, { passive:false });

    const activePointers = new Map();

    viewerImg.addEventListener("pointerdown", (e) => {
      if(!imgViewer.classList.contains("show")) return;

      viewerImg.setPointerCapture(e.pointerId);
      activePointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      const now = Date.now();
      const dt = now - lastTapTime;
      const dist = Math.hypot(e.clientX - lastTapX, e.clientY - lastTapY);

      if (dt < 280 && dist < 28) {
        if (scale <= 1.05) zoomTo(2.2, e.clientX, e.clientY);
        else resetTransform();
        lastTapTime = 0;
        return;
      }
      lastTapTime = now;
      lastTapX = e.clientX;
      lastTapY = e.clientY;

      if (activePointers.size === 1 && scale > 1) {
        dragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
      }

      if (activePointers.size === 2) {
        pinching = true;
        dragging = false;
        const pts = Array.from(activePointers.values());
        pinchStartDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
        pinchStartScale = scale;
        pinchMidX = (pts[0].x + pts[1].x) / 2;
        pinchMidY = (pts[0].y + pts[1].y) / 2;
      }
    });

    viewerImg.addEventListener("pointermove", (e) => {
      if (!activePointers.has(e.pointerId)) return;
      activePointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      if (pinching && activePointers.size === 2) {
        const pts = Array.from(activePointers.values());
        const dist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
        const factor = dist / (pinchStartDist || dist);
        const targetScale = clamp(pinchStartScale * factor, 1, 4);
        zoomTo(targetScale, pinchMidX, pinchMidY);
        return;
      }

      if (dragging && scale > 1 && activePointers.size === 1) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        applyTransform();
      }
    });

    viewerImg.addEventListener("pointerup", (e) => {
      activePointers.delete(e.pointerId);
      if (activePointers.size < 2) pinching = false;
      if (activePointers.size === 0) dragging = false;
    });

    viewerImg.addEventListener("pointercancel", (e) => {
      activePointers.delete(e.pointerId);
      if (activePointers.size < 2) pinching = false;
      if (activePointers.size === 0) dragging = false;
    });


        /* ===============================
       ‚úÖ MUSIC SYSTEM (your original)
    ============================== */
    const audio = document.getElementById("bgm");

    const MUSIC_DIR = "sounds/";
    const TRACKS = [
      "bgm_0001.ogg","bgm_0002.ogg","bgm_0003.ogg","bgm_0004.ogg","bgm_0005.ogg",
      "bgm_0006.ogg","bgm_0007.ogg","bgm_0008.ogg","bgm_0009.ogg","bgm_0010.ogg",
      "bgm_0011.ogg","bgm_0012.ogg","bgm_0013.ogg","bgm_0014.ogg","bgm_0015.ogg",
      "bgm_0016.ogg","bgm_0017.ogg","bgm_0018.ogg","bgm_0019.ogg","bgm_0020.ogg",
    ];

    const musicWidget = document.getElementById("musicWidget");
    const songName = document.getElementById("songName");
    const songStatus = document.getElementById("songStatus");
    const trackPill = document.getElementById("trackPill");
    const modePill = document.getElementById("modePill");
    const miniStatus = document.getElementById("miniStatus");

    const playBtn = document.getElementById("playBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const minBtn = document.getElementById("minBtn");
    const expandBtn = document.getElementById("expandBtn");
    const volRange = document.getElementById("volRange");

    const KEY_INDEX = "bfn_bgm_index";
    const KEY_TIME  = "bfn_bgm_time";
    const KEY_VOL   = "bfn_bgm_vol";
    const KEY_SHUF  = "bfn_bgm_shuffle";
    const KEY_MIN   = "bfn_bgm_minimized";

    function clampInt(n, min, max, fallback){
      if (!Number.isFinite(n)) return fallback;
      return Math.max(min, Math.min(max, n));
    }
    function niceName(filename){ return filename.replace(/\.[^/.]+$/, ""); }

    let idx = clampInt(parseInt(localStorage.getItem(KEY_INDEX)), 0, TRACKS.length - 1, 0);
    let shuffle = (localStorage.getItem(KEY_SHUF) === "1");
    let minimized = (localStorage.getItem(KEY_MIN) === "1");
    let userUnlockedAudio = false;

    audio.preload = "auto";
    audio.loop = false;
    audio.playsInline = true;

    let savedVol = parseInt(localStorage.getItem(KEY_VOL));
    if (Number.isFinite(savedVol)) {
      savedVol = Math.max(0, Math.min(100, savedVol));
      volRange.value = String(savedVol);
      audio.volume = savedVol / 100;
    } else {
      audio.volume = 0.5;
      volRange.value = "50";
    }

    if (minimized) musicWidget.classList.add("minimized");

    function setStatus(text){
      songStatus.textContent = text;
      miniStatus.textContent = "üéµ " + (text === "Playing" ? "Playing" : "BGM");
    }
    function updateTrackUI(){
      songName.textContent = "üéµ " + niceName(TRACKS[idx]);
      trackPill.textContent = `Track: ${idx + 1}/${TRACKS.length}`;
      modePill.textContent = shuffle ? "Mode: Shuffle" : "Mode: Loop";
    }
    function updatePlayButton(){ playBtn.textContent = audio.paused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è"; }
    function updateShuffleUI(){ shuffleBtn.style.opacity = shuffle ? "1" : ".75"; updateTrackUI(); }

    function loadTrack(newIndex, keepTime){
      idx = clampInt(newIndex, 0, TRACKS.length - 1, 0);
      const src = MUSIC_DIR + TRACKS[idx];
      localStorage.setItem(KEY_INDEX, String(idx));

      const oldTime = audio.currentTime || 0;
      audio.src = src;
      audio.load();

      if (keepTime) audio.currentTime = oldTime;
      else audio.currentTime = 0;

      updateTrackUI();
      updatePlayButton();
    }

    function nextTrack(){
      if (shuffle) {
        let next = idx;
        if (TRACKS.length > 1) while (next === idx) next = Math.floor(Math.random() * TRACKS.length);
        loadTrack(next, false);
      } else {
        loadTrack((idx + 1) % TRACKS.length, false);
      }
      playSafe();
    }
    function prevTrack(){ loadTrack((idx - 1 + TRACKS.length) % TRACKS.length, false); playSafe(); }

    async function playSafe(){
      try{
        await audio.play();
        userUnlockedAudio = true;
        setStatus("Playing");
        updatePlayButton();
      }catch{
        setStatus("Tap ‚ñ∂ to start");
        updatePlayButton();
      }
    }
    function pauseMusic(){ audio.pause(); setStatus("Paused"); updatePlayButton(); }
    async function togglePlay(){ if (audio.paused) await playSafe(); else pauseMusic(); }

    async function attemptAutoplay(){
      setStatus("Loading...");
      updatePlayButton();
      try{
        await audio.play();
        userUnlockedAudio = true;
        setStatus("Playing");
        updatePlayButton();
      }catch{
        setStatus("Tap ‚ñ∂ to start");
        updatePlayButton();
      }
    }

    loadTrack(idx, false);
    updateShuffleUI();
    attemptAutoplay();

    playBtn.addEventListener("click", togglePlay);
    nextBtn.addEventListener("click", nextTrack);
    prevBtn.addEventListener("click", prevTrack);

    shuffleBtn.addEventListener("click", () => {
      shuffle = !shuffle;
      localStorage.setItem(KEY_SHUF, shuffle ? "1" : "0");
      updateShuffleUI();
    });

    minBtn.addEventListener("click", () => {
      musicWidget.classList.add("minimized");
      localStorage.setItem(KEY_MIN, "1");
    });

    expandBtn.addEventListener("click", () => {
      musicWidget.classList.remove("minimized");
      localStorage.setItem(KEY_MIN, "0");
    });

    volRange.addEventListener("input", () => {
      const v = clampInt(parseInt(volRange.value), 0, 100, 50);
      audio.volume = v / 100;
      localStorage.setItem(KEY_VOL, String(v));
    });

    audio.addEventListener("ended", () => {
      if (shuffle) nextTrack();
      else { audio.currentTime = 0; playSafe(); }
    });

    audio.addEventListener("play", () => { setStatus("Playing"); updatePlayButton(); });
    audio.addEventListener("pause", () => { setStatus("Paused"); updatePlayButton(); });

    ["click","touchstart","pointerdown","keydown"].forEach(evt => {
      window.addEventListener(evt, () => {
        if (userUnlockedAudio) return;
        if (songStatus.textContent.includes("Tap")) playSafe();
      }, { once:false, passive:true });
    });
  </script>

</body>
</html>
