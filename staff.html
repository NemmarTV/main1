<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bisaya Fire Nation</title>

  <meta name="theme-color" content="#ff4500" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="images/bfn.png" />
  <link rel="apple-touch-icon" href="images/bfn.png" />

  <link rel="stylesheet" href="css/style.css" />

  <style>
    .post-meta{font-size:.85rem;opacity:.7;margin-bottom:10px;display:block}

    /* FILTER BUTTONS */
    .staff-filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0 6px;
    }
    .filter-btn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--glass-border, rgba(255,255,255,.28));
      background: var(--glass, rgba(255,255,255,.62));
      box-shadow: var(--shadow, 0 18px 60px rgba(0,0,0,.12));
      cursor:pointer;
      font-weight:700;
      font-size:.85rem;
      color: var(--text, #111);
      user-select:none;
      transition:.15s ease;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .filter-btn:hover{transform:translateY(-1px)}
    .filter-btn.active{
      outline:2px solid rgba(255,69,0,.35);
      border-color: rgba(255,69,0,.55);
    }

    /* STAFF GRID */
    .staff-list{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap:12px;
      margin-top:10px;
    }

    .staff-card{
      padding:12px;
      border-radius:14px;
      background: var(--glass, rgba(255,255,255,.62));
      box-shadow: var(--shadow, 0 18px 60px rgba(0,0,0,.18));
      cursor:pointer;
      transition:.2s ease;
      display:flex;
      gap:10px;
      align-items:center;
      border:2px solid transparent;
      position:relative;
      overflow:hidden;
    }
    .staff-card:hover{transform: translateY(-3px) scale(1.02)}

    /* RANK BORDER COLORS */
    .rank-cm{ border-color: gold; }
    .rank-council{ border-color: #ff3b3b; }
    .rank-event{ border-color: #3b82ff; }
    .rank-booster{ border-color: #8b5cf6; } /* purple */

    /* ‚úÖ BOOSTER GLOW ANIMATION */
    @keyframes boosterGlow{
      0%   { box-shadow: 0 18px 60px rgba(0,0,0,.18), 0 0 0 rgba(139,92,246,.0); }
      50%  { box-shadow: 0 18px 60px rgba(0,0,0,.18), 0 0 18px rgba(139,92,246,.55); }
      100% { box-shadow: 0 18px 60px rgba(0,0,0,.18), 0 0 0 rgba(139,92,246,.0); }
    }
    .glow-booster{ animation: boosterGlow 1.6s ease-in-out infinite; }

    .staff-avatar{
      width:42px;height:42px;border-radius:50%;
      background:#fff;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
      overflow:hidden;
    }
    .staff-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:50%;
    }

    .staff-name{font-weight:800;line-height:1.1}
    .staff-role{font-size:.8rem;opacity:.75;margin-top:2px}

    /* BADGE (emoji) */
    .rank-badge{
      position:absolute;
      top:10px;
      right:10px;
      font-size:18px;
      line-height:1;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
      user-select:none;
    }

    /* MODAL */
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.6);z-index:9999;padding:16px;
    }
    .modal-box{
      width:min(480px, 100%);
      background: var(--bg2, #fff);
      color: var(--text, #111);
      border-radius:18px;
      padding:18px;
      text-align:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      border:3px solid rgba(255,215,0,.9);
      position:relative;
    }
    .modal-badge{
      position:absolute;
      top:12px;
      right:14px;
      font-size:20px;
      line-height:1;
      user-select:none;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }
    .modal-avatar{
      width:90px;height:90px;border-radius:50%;
      margin:0 auto 10px;background:#f1f1f1;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .modal-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:50%;
    }

    .modal-roles{
      font-size:.9rem;
      opacity:.85;
      margin:6px 0 0;
      line-height:1.35;
    }

    .modal-box button{
      margin-top:14px;width:100%;padding:10px;border:none;border-radius:12px;
      background:#ff4500;color:#fff;font-weight:800;cursor:pointer;
    }

    /* =========================
       ‚úÖ MUSIC WIDGET MINIMIZE CSS
       (If your style.css already has this, it still works.)
    ========================= */
    .music-widget{ position:fixed; right:14px; bottom:14px; z-index:9998; }
    .music-mini-bar{ display:none; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:14px; }
    .music-min-btn{ border:none; border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:800; }

    .music-widget.minimized .music-top,
    .music-widget.minimized .music-controls,
    .music-widget.minimized .music-row,
    .music-widget.minimized .music-mini{
      display:none !important;
    }
    .music-widget.minimized .music-mini-bar{
      display:flex !important;
    }
  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="logo" onclick="window.scrollTo({top:0, behavior:'smooth'})">
      <img src="images/bfn.png" alt="BFN Logo" />
    </div>

    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="update.html">Update</a>
      <a href="event.html">Events</a>
      <a href="download.html">Downloads</a>
      <a href="staff.html">Staff</a>
    </nav>

    <button id="themeToggle" title="Toggle Theme" aria-label="Toggle Theme">‚òÄÔ∏è</button>
  </div>
</header>

<div class="container">
  <main>

    <article class="post">
      <h2>üî• BFN Staff</h2>
      <span class="post-meta">Use filters or click a staff to view profile</span>

      <!-- ‚úÖ FILTER BUTTONS -->
      <div class="staff-filters" id="staffFilters">
        <button class="filter-btn active" data-filter="all">‚ú® All</button>
        <button class="filter-btn" data-filter="cm">üëë CM</button>
        <button class="filter-btn" data-filter="council">üî• Council</button>
        <button class="filter-btn" data-filter="event">üéØ Event</button>
        <button class="filter-btn" data-filter="booster">üöÄ Server Booster</button>
      </div>

      <div id="staffList" class="staff-list"></div>
    </article>

  </main>
</div>

<!-- PROFILE MODAL -->
<div class="modal" id="profileModal" onclick="closeProfile()">
  <div class="modal-box" id="modalBox" onclick="event.stopPropagation()">
    <div class="modal-badge" id="modalBadge">üëë</div>

    <div class="modal-avatar">
      <img id="profileAvatar" alt="Avatar">
    </div>

    <h3 id="profileName"></h3>
    <p id="profileRole"></p>
    <p class="modal-roles" id="profileRoles"></p>
    <p id="profileDesc"></p>

    <button type="button" onclick="closeProfile()">Close</button>
  </div>
</div>

<!-- ‚úÖ AUDIO -->
<audio id="bgm" preload="auto"></audio>

<!-- ‚úÖ MUSIC WIDGET (Minimize + Full Controls) -->
<div class="music-widget" id="musicWidget">

  <!-- MINIMIZED BAR -->
  <div class="music-mini-bar">
    <span id="miniStatus">üéµ BGM</span>
    <button class="music-min-btn" id="expandBtn" title="Expand" type="button">‚¨ÜÔ∏è</button>
  </div>

  <!-- FULL PLAYER -->
  <div class="music-top">
    <div class="music-title" id="songName">üéµ BFN BGM</div>
    <div class="music-status" id="songStatus">Paused</div>
  </div>

  <div class="music-controls">
    <button class="m-btn" id="prevBtn" title="Previous" type="button">‚èÆÔ∏è</button>
    <button class="m-btn primary" id="playBtn" title="Play/Pause" type="button">‚ñ∂Ô∏è</button>
    <button class="m-btn" id="nextBtn" title="Next" type="button">‚è≠Ô∏è</button>
    <button class="m-btn" id="shuffleBtn" title="Shuffle" type="button">üîÄ</button>
    <button class="m-btn" id="minBtn" title="Minimize" type="button">‚ûñ</button>
  </div>

  <div class="music-row">
    <span class="vol-label">üîä Vol</span>
    <input id="volRange" class="vol-range" type="range" min="0" max="100" value="50">
  </div>

  <div class="music-mini">
    <span class="pill" id="modePill">Mode: Loop</span>
    <span class="pill" id="trackPill">Track: 1/4</span>
  </div>
</div>

<script>
/* =========================
   ‚úÖ THEME TOGGLE (ONE ONLY)
========================= */
const toggle = document.getElementById("themeToggle");
const root = document.documentElement;

const savedTheme = localStorage.getItem("theme") || "light";
root.setAttribute("data-theme", savedTheme);
toggle.textContent = savedTheme === "light" ? "‚òÄÔ∏è" : "üåô";

toggle.addEventListener("click", () => {
  const newTheme = root.getAttribute("data-theme") === "light" ? "dark" : "light";
  root.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  toggle.textContent = newTheme === "light" ? "‚òÄÔ∏è" : "üåô";
});

/* =========================
   AVATAR SETTINGS
========================= */
const PROFILE_PATH = "images/profile/";
const defaultAvatar = "https://img.icons8.com/?size=100&id=7819&format=png&color=000000";

function localAvatar(filename){ return PROFILE_PATH + filename; }

function setAvatar(imgEl, src){
  imgEl.src = src || defaultAvatar;
  imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = defaultAvatar; };
}

/* =========================
   PROFILE MODAL (ONE ONLY)
========================= */
const profileModal = document.getElementById("profileModal");
const modalBox = document.getElementById("modalBox");
const modalBadge = document.getElementById("modalBadge");
const profileName = document.getElementById("profileName");
const profileRole = document.getElementById("profileRole");
const profileRoles = document.getElementById("profileRoles");
const profileDesc = document.getElementById("profileDesc");
const profileAvatar = document.getElementById("profileAvatar");

function openProfile(member, style){
  profileName.textContent = member.name;

  const primaryRole = (member.roles && member.roles.length) ? member.roles[0] : "Member";
  profileRole.textContent = "Role: " + primaryRole;

  const rolesLine = (member.roles && member.roles.length)
    ? ("All Roles: " + member.roles.join(" ‚Ä¢ "))
    : "";
  profileRoles.textContent = rolesLine;

  profileDesc.textContent = member.desc || "";
  setAvatar(profileAvatar, member.avatar);

  modalBox.className = "modal-box " + (style.cls || "") + (style.glow ? " glow-booster" : "");
  modalBadge.textContent = style.badge || "";

  profileModal.style.display = "flex";
}
function closeProfile(){ profileModal.style.display = "none"; }

// ESC to close
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeProfile();
});

/* =========================
   RAW STAFF DATA (can contain duplicates)
========================= */
const rawStaffData = [
  { name:"CMNems[F]‚Ñ¢", role:"Clan Master", rank:"cm", desc:"Founder and leader of Bisaya Fire Nation.", avatar: localAvatar("cmnems.jpg") },
  { name:"Aesun[F]", role:"Vice Clan Master", rank:"cm", desc:"Handles operations and clan management.", avatar: localAvatar("aesun.png") },
  { name:"Nash[F]", role:"Vice Clan Master", rank:"cm", desc:"Strategic and event support leader.", avatar: localAvatar("nash.jpg") },
  { name:"OneAboveAll[F]", role:"Shadow CM", rank:"cm", desc:"Silent enforcer and high command support.", avatar: localAvatar("shawe.jpg") },

  { name:"Kiet[F]", role:"High Council", rank:"council", desc:"Clan decision maker and senior member.", avatar: localAvatar("kiet.png") },
  { name:"Shokolayte[F]", role:"High Council / Event Manager", rank:"event", desc:"Handles events and major planning.", avatar: localAvatar("shoko.jpg") },

  { name:"Sebii[F]", role:"Event Manager", rank:"event", desc:"Organizes tournaments and activities.", avatar: localAvatar("sebii.png") },

  { name:"[CMGR] JamerLF | Jam", role:"Server Technician", rank:"other", desc:"Maintains server stability and tools.", avatar: localAvatar("jamer.webp") },
  { name:"Pinkish", role:"Server Technician", rank:"other", desc:"Helps manage technical issues and systems.", avatar: localAvatar("pinkish.png") },

  { name:"Madison[F]", role:"Examiner", rank:"other", desc:"Checks members and manages assessments.", avatar: localAvatar("Madison.webp") },
  { name:"Nekoneppu[F]", role:"Examiner", rank:"other", desc:"Supports recruitment and evaluations.", avatar: localAvatar("neko.webp") },

  { name:"Jefax[F]", role:"Muse", rank:"other", desc:"Creative contributor of the clan.", avatar: localAvatar("jefax.png") },
  { name:"Jyxie", role:"Muse", rank:"other", desc:"Design and creative support.", avatar: localAvatar("jyxie.png") },

  { name:"Mystogan[F]", role:"Escort", rank:"other", desc:"Protects members and handles security.", avatar: localAvatar("mystogan.png") },

  // SERVER BOOSTERS (may duplicate existing names)
  { name:"[CMGR] JamerLF|Jam", role:"Server Booster", rank:"booster", desc:"Supports the server and boosts the community.", avatar: localAvatar("jamer.webp") },
  { name:"Angie", role:"Server Booster", rank:"booster", desc:"Server supporter and community booster.", avatar: localAvatar("angie.png") },
  { name:"Dream[F]", role:"Server Booster", rank:"booster", desc:"Active supporter of the clan and server.", avatar: localAvatar("dream.jpg") },
  { name:"Kiet[F]", role:"Server Booster", rank:"booster", desc:"Boosts and supports the community.", avatar: localAvatar("kiet.png") },
  { name:"OneAboveAll[F] - Shadow CM", role:"Server Booster", rank:"booster", desc:"High command supporter and server booster.", avatar: localAvatar("shawe.jpg") },
  { name:"Sebii[F]", role:"Server Booster", rank:"booster", desc:"Event helper and server booster.", avatar: localAvatar("sebii.png") },
];

/* =========================
   MERGE DUPLICATES (by normalized name)
========================= */
function normalizeName(n){
  return String(n || "")
    .trim()
    .replace(/\s+/g, " ")
    .replace(/\|/g, " | ")
    .replace(/\s+\|\s+/g, " | ")
    .toLowerCase();
}

function mergeStaff(list){
  const map = new Map();

  for(const item of list){
    const key = normalizeName(item.name);
    if(!key) continue;

    if(!map.has(key)){
      map.set(key, {
        name: item.name,
        avatar: item.avatar,
        desc: item.desc || "",
        roles: item.role ? [item.role] : [],
        ranks: item.rank ? [item.rank] : [],
      });
      continue;
    }

    const existing = map.get(key);

    if(String(item.name || "").length > String(existing.name || "").length){
      existing.name = item.name;
    }

    if(!existing.avatar && item.avatar) existing.avatar = item.avatar;

    const a = String(existing.desc || "");
    const b = String(item.desc || "");
    if(b.length > a.length) existing.desc = b;

    if(item.role && !existing.roles.includes(item.role)) existing.roles.push(item.role);
    if(item.rank && !existing.ranks.includes(item.rank)) existing.ranks.push(item.rank);
  }

  return Array.from(map.values());
}

let staffData = mergeStaff(rawStaffData);

/* =========================
   SHUFFLE
========================= */
function shuffle(array){
  for(let i = array.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
shuffle(staffData);

/* =========================
   RANK PRIORITY + STYLE
========================= */
const rankPriority = ["cm", "council", "event", "booster", "other"];

function primaryRank(member){
  const ranks = member.ranks || [];
  for(const r of rankPriority){
    if(ranks.includes(r)) return r;
  }
  return "other";
}

function getRankStyleForMember(member){
  const rank = primaryRank(member);
  const hasBooster = (member.ranks || []).includes("booster");

  if(rank === "cm") return { cls: "rank-cm", badge: "üëë", glow:false };
  if(rank === "council") return { cls: "rank-council", badge: "üî•", glow:false };
  if(rank === "event") return { cls: "rank-event", badge: "üéØ", glow:false };
  if(rank === "booster") return { cls: "rank-booster", badge: "üöÄ", glow:true };

  return { cls: "", badge: "", glow: hasBooster };
}

/* =========================
   RENDER STAFF
========================= */
const staffList = document.getElementById("staffList");

function displayRoles(member){
  const roles = member.roles || [];
  if(!roles.length) return "Member";
  if(roles.length <= 2) return roles.join(" ‚Ä¢ ");
  return roles.slice(0,2).join(" ‚Ä¢ ") + ` ‚Ä¢ +${roles.length - 2}`;
}

function matchesFilter(member, filter){
  if(filter === "all") return true;
  const ranks = member.ranks || [];
  return ranks.includes(filter);
}

function renderStaff(filter){
  staffList.innerHTML = "";

  staffData
    .filter(m => matchesFilter(m, filter))
    .forEach(member => {
      const style = getRankStyleForMember(member);

      const card = document.createElement("div");
      card.className = "staff-card " + (style.cls || "") + (style.glow ? " glow-booster" : "");

      card.innerHTML = `
        <div class="rank-badge">${style.badge || ""}</div>
        <div class="staff-avatar"><img alt="Avatar"></div>
        <div>
          <div class="staff-name">${member.name}</div>
          <div class="staff-role">${displayRoles(member)}</div>
        </div>
      `;

      const img = card.querySelector(".staff-avatar img");
      setAvatar(img, member.avatar);

      card.addEventListener("click", () => openProfile(member, style));
      staffList.appendChild(card);
    });
}
renderStaff("all");

/* FILTER BUTTONS */
const filtersWrap = document.getElementById("staffFilters");
filtersWrap.addEventListener("click", (e) => {
  const btn = e.target.closest(".filter-btn");
  if(!btn) return;

  const filter = btn.dataset.filter;

  document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  renderStaff(filter);
});

/* =========================
   üéµ BFN MUSIC SYSTEM (FULL + MINIMIZE)
   - FIXED: removed duplicate modal/theme code
   - FIXED: removed broken localStorage key with weird quote
   - FIXED: name typo for bgm_0010.ogg
========================= */
const bgm = document.getElementById("bgm");

const songName = document.getElementById("songName");
const songStatus = document.getElementById("songStatus");
const trackPill = document.getElementById("trackPill");
const modePill = document.getElementById("modePill");
const miniStatus = document.getElementById("miniStatus");

const prevBtn = document.getElementById("prevBtn");
const playBtn = document.getElementById("playBtn");
const nextBtn = document.getElementById("nextBtn");
const shuffleBtn = document.getElementById("shuffleBtn");
const volRange = document.getElementById("volRange");

const musicWidget = document.getElementById("musicWidget");
const minBtn = document.getElementById("minBtn");
const expandBtn = document.getElementById("expandBtn");

const playlist = [
  { src: "sounds/bgm_0001.ogg", name: "bgm_0001.ogg" },
  { src: "sounds/bgm_0002.ogg", name: "bgm_0002.ogg" },
  { src: "sounds/bgm_0003.ogg", name: "bgm_0003.ogg" },
  { src: "sounds/bgm_0004.ogg", name: "bgm_0004.ogg" },
  { src: "sounds/bgm_0005.ogg", name: "bgm_0005.ogg" },
  { src: "sounds/bgm_0006.ogg", name: "bgm_0006.ogg" },
  { src: "sounds/bgm_0007.ogg", name: "bgm_0007.ogg" },
  { src: "sounds/bgm_0008.ogg", name: "bgm_0008.ogg" },
  { src: "sounds/bgm_0009.ogg", name: "bgm_0009.ogg" },
  { src: "sounds/bgm_0010.ogg", name: "bgm_0010.ogg" }, /* ‚úÖ fixed name */
  { src: "sounds/bgm_0011.ogg", name: "bgm_0011.ogg" },
  { src: "sounds/bgm_0012.ogg", name: "bgm_0012.ogg" },
  { src: "sounds/bgm_0013.ogg", name: "bgm_0013.ogg" },
  { src: "sounds/bgm_0014.ogg", name: "bgm_0014.ogg" },
  { src: "sounds/bgm_0015.ogg", name: "bgm_0015.ogg" },
  { src: "sounds/bgm_0016.ogg", name: "bgm_0016.ogg" },
  { src: "sounds/bgm_0017.ogg", name: "bgm_0017.ogg" },
  { src: "sounds/bgm_0018.ogg", name: "bgm_0018.ogg" },
  { src: "sounds/bgm_0019.ogg", name: "bgm_0019.ogg" },
  { src: "sounds/bgm_0020.ogg", name: "bgm_0020.ogg" }
];

const LS = {
  enabled:   "bfn_music_enabled",    // "on"/"off"
  index:     "bfn_music_index",      // 0..n-1
  volume:    "bfn_music_volume",     // 0..1
  shuffle:   "bfn_music_shuffle",    // 0/1
  playing:   "bfn_music_playing",    // 0/1
  minimized: "bfn_music_minimized"   // 0/1
};

// Cleanup: remove older broken key if it exists (with weird apostrophe)
try{
  for (let i = 0; i < localStorage.length; i++){
    const k = localStorage.key(i);
    if (k && k.includes("bfn_music_play") && k !== LS.playing){
      const v = localStorage.getItem(k);
      if (localStorage.getItem(LS.playing) === null && v != null) localStorage.setItem(LS.playing, v);
      localStorage.removeItem(k);
    }
  }
}catch(_){}

let musicEnabled = localStorage.getItem(LS.enabled) ?? "on";

let currentIndex = parseInt(localStorage.getItem(LS.index) ?? "0", 10);
if (Number.isNaN(currentIndex) || currentIndex < 0 || currentIndex >= playlist.length) currentIndex = 0;

let shuffleOn = (localStorage.getItem(LS.shuffle) ?? "0") === "1";
let wantPlaying = (localStorage.getItem(LS.playing) ?? "0") === "1";
let startedOnce = false;

// Volume restore
let savedVol = parseFloat(localStorage.getItem(LS.volume) ?? "0.5");
if (Number.isNaN(savedVol) || savedVol < 0 || savedVol > 1) savedVol = 0.5;
bgm.volume = savedVol;
volRange.value = String(Math.round(savedVol * 100));

function updateMiniBar(){
  miniStatus.textContent = (bgm.paused ? "‚è∏Ô∏è " : "‚ñ∂Ô∏è ") + playlist[currentIndex].name;
}

function setSongUI(){
  songName.textContent = "üéµ " + playlist[currentIndex].name;
  trackPill.textContent = `Track: ${currentIndex + 1}/${playlist.length}`;
  modePill.textContent = shuffleOn ? "Mode: Shuffle" : "Mode: Loop";
  shuffleBtn.style.opacity = shuffleOn ? "1" : ".65";
  updateMiniBar();
}

function setStatusUI(){
  const isPaused = bgm.paused;
  songStatus.textContent = (musicEnabled === "off") ? "Off" : (isPaused ? "Paused" : "Playing");
  playBtn.textContent = (musicEnabled === "off") ? "‚ñ∂Ô∏è" : (isPaused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è");
  playBtn.title = isPaused ? "Play" : "Pause";
  updateMiniBar();
}

function loadTrack(index){
  currentIndex = index;
  localStorage.setItem(LS.index, String(currentIndex));
  bgm.src = playlist[currentIndex].src;
  bgm.load();
  setSongUI();
  setStatusUI();
}

function pickRandomIndex(exceptIndex){
  if (playlist.length <= 1) return 0;
  let idx = Math.floor(Math.random() * playlist.length);
  if (idx === exceptIndex) idx = (idx + 1) % playlist.length;
  return idx;
}

async function safePlay(){
  if (musicEnabled === "off") return;
  try{
    await bgm.play();
    startedOnce = true;
    localStorage.setItem(LS.playing, "1");
  }catch(e){
    // blocked until user gesture
  }
  setStatusUI();
}

function pauseMusic(){
  bgm.pause();
  localStorage.setItem(LS.playing, "0");
  setStatusUI();
}

function nextTrack(){
  const nextIndex = shuffleOn ? pickRandomIndex(currentIndex)
                             : (currentIndex + 1) % playlist.length;
  loadTrack(nextIndex);
  safePlay();
}

function prevTrack(){
  const prevIndex = shuffleOn ? pickRandomIndex(currentIndex)
                             : (currentIndex - 1 + playlist.length) % playlist.length;
  loadTrack(prevIndex);
  safePlay();
}

/* Minimize */
function setMinimized(min){
  if (min){
    musicWidget.classList.add("minimized");
    localStorage.setItem(LS.minimized, "1");
  }else{
    musicWidget.classList.remove("minimized");
    localStorage.setItem(LS.minimized, "0");
  }
}

minBtn.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  setMinimized(true);
});

expandBtn.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  setMinimized(false);
});

// Track ended -> next
bgm.addEventListener("ended", nextTrack);

// Buttons
playBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  e.stopPropagation();

  if (musicEnabled === "off"){
    musicEnabled = "on";
    localStorage.setItem(LS.enabled, "on");
    await safePlay();
    return;
  }

  if (bgm.paused) await safePlay();
  else pauseMusic();
});

nextBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); nextTrack(); });
prevBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); prevTrack(); });

shuffleBtn.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();
  shuffleOn = !shuffleOn;
  localStorage.setItem(LS.shuffle, shuffleOn ? "1" : "0");
  setSongUI();
});

volRange.addEventListener("input", () => {
  const v = Number(volRange.value) / 100;
  bgm.volume = v;
  localStorage.setItem(LS.volume, String(v));
  updateMiniBar();
});

// Autoplay on first interaction (browser rule)
function shouldTriggerBGM(target){
  return target.closest("a, button, .btn, .poster, .logo, .nav, .sidebar, .music-widget");
}

async function firstUserStart(e){
  if (!shouldTriggerBGM(e.target)) return;

  if (!startedOnce && wantPlaying && musicEnabled !== "off"){
    await safePlay();
  }

  document.removeEventListener("pointerdown", firstUserStart);
  document.removeEventListener("click", firstUserStart);
}

document.addEventListener("pointerdown", firstUserStart, { passive:true });
document.addEventListener("click", firstUserStart);

// Save on unload
window.addEventListener("beforeunload", () => {
  localStorage.setItem(LS.enabled, musicEnabled);
  localStorage.setItem(LS.index, String(currentIndex));
  localStorage.setItem(LS.shuffle, shuffleOn ? "1" : "0");
  localStorage.setItem(LS.volume, String(bgm.volume));
  localStorage.setItem(LS.playing, bgm.paused ? "0" : "1");
  localStorage.setItem(LS.minimized, musicWidget.classList.contains("minimized") ? "1" : "0");
});

// Init
loadTrack(currentIndex);

const wasMin = (localStorage.getItem(LS.minimized) ?? "0") === "1";
if (wasMin) setMinimized(true);

if (musicEnabled === "off"){
  pauseMusic();
  songStatus.textContent = "Off";
} else {
  setStatusUI();
}

/* ‚úÖ SERVICE WORKER (ONE ONLY) */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(() => {});
}
</script>

</body>
</html>
